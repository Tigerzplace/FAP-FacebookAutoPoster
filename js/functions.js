/* ================================================================
   functions.js â€“ Shared Utilities for FAP
   Purpose:
     - DOM visibility helpers
     - Logging helpers
     - Facebook parsing helpers
     - UI event logging
     - Random generation utilities
     - Encoding utilities
     - Login & profile parsing helpers

   NOTE:
     * No functionality changed.
     * No code removed.
     * Only structured, grouped, and documented.
================================================================ */

function showElement(e){const t=document.getElementById(e);t?t.style.display="block":log("error",`Element with id ${e} not found`,null,"showElement")}function hideElement(e){const t=document.getElementById(e);t?t.style.display="none":log("error",`Element with id ${e} not found`,null,"hideElement")}function showElementByClass(e){const t=FAP.querySelector(`.${e}`);t?t.style.display="unset":log("error",`Element with class ${e} not found`,null,"showElementByClass")}function hideElementByClass(e){const t=FAP.querySelector(`.${e}`);t?t.style.display="none":log("error",`Element with class ${e} not found`,null,"hideElementByClass")}function toggleElement(e){const t=document.getElementById(e);t?t.style.display="none"===t.style.display?"block":"none":log("error",`Element with id ${e} not found`,null,"toggleElement")}function toggleElementDisplay(e){e.style.display="block"===e.style.display?"none":"block"}function setElementHTML(e,t){const o=document.getElementById(e);o?o.innerHTML=t:log("error",`Element with id ${e} not found`,null,"setElementHTML")}function getElementValue(e){const t=document.getElementById(e);return t?t.value:(log("error",`Element with id ${e} not found`,null,"getElementValue"),null)}function log(e="log",t="",o=null,n=""){console[e](`${n?`[${n}] `:""}${t}`,o)}function htmlEntities(e){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}function homeTab(){hideElement("license"),showElement("first"),hideElement("loadingProgress")}function findGroup_ID(e,t,o,n){let r="";let l=30;e+=9;for(let t=0;t<=l;t++)"%"!==fb[e]&&"&"!==fb[e]?(r+=fb[e],e++):l=t;log("info",`Found Group ID: ${r}`,null,"findGroup_ID"),assignGroups(t,o,n,r)}function myLicense(){showElement("license"),hideElement("first")}karKom&&(console.log=()=>{},console.error=()=>{},console.warn=()=>{},console.info=()=>{},console.debug=()=>{});let eventTextCount=0,eventText="",eventGroupName="",eventGroupLink="";function eventLog(){let e=FAP.getElementById("logBody");if(e){for(;eventTextCount<eventText.length;)e.innerHTML+=eventText.charAt(eventTextCount),eventTextCount++;eventText="",eventTextCount=0,groupLink()}else log("error","logBody element not found",null,"eventLog")}function groupLink(){let e=FAP.createElement("a"),t=FAP.createTextNode(eventGroupName);e.appendChild(t),e.title=eventGroupName,e.href=eventGroupLink,e.target="_blank";let o=FAP.getElementById("logBody");return o?(o.appendChild(e),o.appendChild(FAP.createElement("br"))):log("error","logBody element not found",null,"groupLink"),eventGroupName="",eventGroupLink="",1}function ultaKa(e){return e.split("").reverse().join("")}function htmlEnt(e){return e.replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/"/g,"&quot;")}function customEncodeURIComponent(e){return encodeURIComponent(e).replace(/%20/g," ").replace(/%3C/g,"<").replace(/%3E/g,">").replace(/%26/g,"&")}function encodeMessageExceptLinks(e){const t=/https?:\/\/[^\s]+/g,o=e.split(t),n=e.match(t);return o.map((e,t)=>{let o=customEncodeURIComponent(e);return n&&n[t]&&(o+=n[t]),o}).join("")}function randomNum(){return Math.floor(15*Math.random())+1}function randomString(){let e="";const t="0123456789";for(let o=0;o<randomNum();o++)e+=t.charAt(Math.floor(10*Math.random()));return"0"===e&&(e="6117"),log("info","Generated Random String",e,"randomString"),`%0D%0A%0D%0A${e}`}function getRandom(e,t){return Math.floor(Math.random()*(t-e+1))+e}async function pickRandomPost(){randomPostNum=getRandom(1,multiplePosts),log("info","Random post number selected",randomPostNum,"pickRandomPost"),randomPostMsgID=textAreaID+randomPostNum;const e=getElementValue(randomPostMsgID);postMsg=e,log("info","Post message content",postMsg,"pickRandomPost")}function getRandomGroupLimit(){const e={min:1901,max:3e3};return getRandom(e.min,e.max)}function getRandomTime(e){if("custom"===e){const e=getCustomMinutesRange();return e?getRandom(e.minSeconds,e.maxSeconds):60}const t={20:{min:1,max:20},60:{min:21,max:60},180:{min:61,max:180},1200:{min:181,max:1200},1800:{min:1201,max:1800},3600:{min:1801,max:3600}}[e];return log("info","Selected time range",t,"getRandomTime"),t?getRandom(t.min,t.max):(log("error","Invalid time value",e,"getRandomTime"),null)}function calculateWaitTime(){if("fixed"===waitTimeMethod){const e=parseFloat(getElementValue("waitTimeSelectFixed"));!isNaN(e)&&e>=0?waitTime=1e3*e:log("error","Invalid fixed value",null,"calculateWaitTime")}else{const e=getElementValue("waitTimeSelectRange");waitTime=1e3*getRandomTime(e)}if(log("info","Calculated wait time",waitTime,"calculateWaitTime"),shtaAoKna.ijazat.status)return waitTime;toastr.error(shtaAoKna.ijazat.reason)}function getCustomMinutesRange(){const e=document.getElementById("customMinMints").value.trim(),t=document.getElementById("customMaxMints").value.trim();let o=parseInt(e),n=parseInt(t);return isNaN(o)||isNaN(n)?(toastr.error("Enter valid numbers for minutes."),null):o<=0||n<=0?(toastr.error("Minutes must be greater than zero."),null):o>180||n>180?(toastr.error("Maximum allowed is 180 minutes."),null):o>=n?(toastr.error("Min value must be smaller than Max."),null):n-o>120?(toastr.error("Difference too large. Keep custom range tighter."),null):{minSeconds:60*o,maxSeconds:60*n}}function checkUserAccount(){FAP.querySelectorAll('a[href^="https://www.facebook.com/"][href*="/friends"]').forEach(e=>{if(/^https:\/\/www\.facebook\.com\/[^\/]+\/friends$/.test(e.href))return 1})}let fbProfile=null,mbasicFB=null,fb_id=null,isMatchFound=!1;async function startLoginCheck(){toastr.info("Trying to Login!"),log("info","Starting login check",null,"startLoginCheck");if(await loginCheck())return toastr.success("You are logged in!"),eventText=`Welcome ${profileData.name}!`,eventLog(),showElement("loadGroups"),showElement("loadGroups_center"),setTimeout(()=>{eventText="Click 'Load Groups' to load all your Facebook groups.",eventLog()},2e3),$(FAP).on("click",'button[id="loadGroups"]',function(){hideElement("loadGroups"),showElement("loader"),genGroupList()}),1;const e="You are not logged in!";return alert(e),eventText=e,eventLog(),setTimeout(()=>toastr.error(e),2400),0}async function loginCheck(){log("info","Starting login check",null,"loginCheck");try{if(fbProfileResponse=await fetch("https://facebook.com/me/about"),200===fbProfileResponse.status){mbasicFB=await fbProfileResponse.text(),fbProfile=document.createElement("div"),fbProfile.innerHTML=mbasicFB;const e=fbProfile.querySelector('img[data-imgperflogname="profileCoverPhoto"]');if(e&&(profileData.cover=e.src||""),!await getPageID())return 0;log("info",`Got ${profileData.type} details`,profileData,"loginCheck"),profileData.fb_dtsg=atob(await getFBValue()).split(",")[0];const t=document.getElementById("profile-picture");t.src=profileData.dp,t.alt=profileData.name,t.title=profileData.name,t.style.backgroundImage=`url(${profileData.dp})`,t.classList.add("show");document.getElementById("profile-link").href=`https://www.facebook.com/${profileData.ID}`,showElement("profile-picture-container");const o=FAP.getElementById("coverImg");return o.style.backgroundImage=`url(${profileData.cover})`,o.style.backgroundSize="cover",o.style.backgroundPosition="left",1}return log("error","Failed to get user details",{profileData:profileData},"loginCheck"),0}catch(e){return log("error","Network error during login check",e,"loginCheck"),toastr.error("Network Error"),0}}async function getPageID(){try{const e={Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8","Sec-Fetch-Dest":"document","Sec-Fetch-Mode":"navigate","Sec-Fetch-Site":"same-origin"},t="https://www.facebook.com/me/about",o=await fetch(t,{headers:e});if(!o.ok){const e=`HTTP error! Status: ${o.status}`;return log("error",e,null,"getPageID"),toastr.error(e),null}const n=await o.text(),r=n.match(/{"ACCOUNT_ID":"[^}]+}/);if(!r)return log("error","Page ID not found.",null,"getPageID"),toastr.error("Page ID not found."),null;const l=JSON.parse(r[0]),a=l.ACCOUNT_ID,i=l.USER_ID,s=l.NAME;l.PAGE_MESSAGING_MAILBOX_ID&&(profileData.type="page"),log("info","Extracted Page Details",{name:s,pageId:i,accountId:a},"getPageID"),profileData.name=s,profileData.ID=i;const c=n.match(/"profile_picture":\s*{[^}]+}/);if(c)try{const e=c[0],t=JSON.parse(`{${e}}`);profileData.dp=t.profile_picture.uri}catch(e){log("error","Error parsing Pic JSON",e,"getPageID")}return 1}catch(e){const t=`An error occurred: ${e.message}`;return log("error",t,e,"getPageID"),toastr.error(t),null}}const parser=new DOMParser;async function getFBValue(){const e=atob("ZmJfZHRzZw==");let t="";const o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";for(let e=0;e<Math.floor(34*Math.random())+8;e++)t+=o.charAt(Math.floor(62*Math.random()));let n=fbProfile.querySelector(`input[name='${e}']`);if(n)fb_id=n.value,isMatchFound=!0;else{let e=fbProfile.querySelectorAll("script[type='application/json'][data-content-len]");for(let t of e){let e=t.textContent,o=e.match(/DTSGInitData",\[\],({.*?})/),n=e.match(/"token":"(.*?)"/);if(o){fb_id=JSON.parse(o[1]).token,isMatchFound=!0;break}if(n){fb_id=n[1],isMatchFound=!0;break}}}return isMatchFound||(log("info","Trying another method to find fb_id",null,"getFBValue"),fb_id=anotherMethod()),fb_id+=","+t,log("info","Final fb_id",fb_id,"getFBValue"),btoa(fb_id)}function anotherMethod(){let e=fbProfile.querySelectorAll("script[type='application/json'][data-content-len]");for(let o of e)try{if(t(JSON.parse(o.textContent)),fb_id)return fb_id}catch(e){log("error","Error parsing JSON",e,"anotherMethod")}function t(e){for(let o in e)if("object"==typeof e[o]&&null!==e[o])t(e[o]);else if("token"===o)return void(fb_id=e[o])}}